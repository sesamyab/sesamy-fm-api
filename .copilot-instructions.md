# Copilot Instructions for Sesamy FM API

## Project Overview

This is a Cloudflare Workers project that provides a podcast management API with audio encoding, transcription, and media processing capabilities.

## Important Project Structure Notes

### Container Setup

- **USE `container_src/` folder** - This is the correct directory for the encoding container
- **DO NOT create a `workers/` folder** - This is incorrect for this project
- The encoding container is in `container_src/` with its own `package.json` and `index.js`
- The main worker code is in `src/` directory

### Key Directories

```
src/                    # Main Cloudflare Worker source code
container_src/          # Encoding container (Durable Object) - USE THIS
data/                   # SQLite database files
drizzle/               # Database migrations
test/                  # Test files
examples/              # Example scripts
```

### Architecture Components

#### Cloudflare Worker (src/)

- Main API endpoints in `src/app.ts`
- Worker entry point in `src/worker.ts`
- Task processing system in `src/tasks/`
- Audio processing in `src/audio/`
- Database schema in `src/database/schema.ts`

#### Encoding Container (container_src/)

- Durable Object for FFmpeg audio encoding
- Runs in a separate container with FFmpeg installed
- Handles streaming progress updates
- **This is NOT a separate worker - it's a Durable Object container**

#### Key Services

- **TaskService** (`src/tasks/service.ts`) - Core task processing system
- **AudioService** (`src/audio/service.ts`) - Audio handling and R2 integration
- **EpisodeService** (`src/episodes/service.ts`) - Episode management
- **ShowService** (`src/shows/service.ts`) - Podcast show management

### Task Types

The system supports these task types:

- `transcribe` - Audio transcription using Cloudflare AI (Whisper)
- `encode` - Audio encoding using FFmpeg in the container
- `audio_preprocess` - Audio preprocessing (32kbps mono conversion)
- `publish` - Episode publishing (stub)
- `notification` - Notification handling (stub)

### Database

- Uses D1 (SQLite) for data storage
- Drizzle ORM for database operations
- R2 for media file storage

### Deployment

- Deploy with `npx wrangler deploy`
- Container is deployed as part of the same project
- Environment variables configured in `wrangler.toml`

## Common Patterns

### Creating Tasks

```typescript
await taskService.createTask("encode", {
  episodeId: "episode-123",
  audioUrl: "https://example.com/audio.mp3",
  outputFormat: "mp3",
  bitrate: 128,
});
```

### File Storage

- Original files stored in R2 under `episodes/{episodeId}/original/`
- Encoded files stored under `episodes/{episodeId}/encoded/`
- Transcripts stored under `transcripts/{episodeId}/`
- Uses signed URLs for secure access

### Testing Endpoints

- `/test/encode` - Test encoding without creating episodes
- `/test/transcribe` - Test transcription
- `/test/audio-preprocess` - Test audio preprocessing

## Development Guidelines

1. **Container Code**: Always modify `container_src/` for encoding-related changes
2. **Worker Code**: Main API logic goes in `src/`
3. **Database Changes**: Use Drizzle migrations in `drizzle/`
4. **New Features**: Follow the existing service/repository pattern
5. **Task Processing**: Extend TaskService for new task types

## Important Notes

- The encoding container uses FFmpeg and requires specific dependencies
- Transcription uses Cloudflare AI Workers (Whisper model)
- All media files use R2 with signed URLs for security
- Task system supports both immediate queue processing and batch processing
- Progress tracking is built into the task system
