# Episode Transcript Endpoint

This document describes the new transcript endpoint that allows fetching episode transcripts in markdown format.

## Endpoint

```
GET /shows/{show_id}/episodes/{episode_id}/transcript
```

## Authentication

Requires JWT authentication with either:

- `podcast:read` permission, OR
- `podcast.read` scope

## Response Formats

The endpoint supports two response formats based on the `Accept` header:

### Markdown Format (Default)

**Accept Header:** `text/markdown` or `text/plain`

**Response:**

```markdown
# Episode Title

**Episode ID:** {episode_id}
**Show:** {show_id}
**Created:** {creation_date}

---

## Transcript

{transcript_content}
```

### JSON Format

**Accept Header:** `application/json`

**Response:**

```json
{
  "transcript": "transcript content here...",
  "episodeId": "uuid",
  "title": "Episode Title",
  "createdAt": "2025-09-09T12:00:00.000Z",
  "transcriptUrl": "https://..."
}
```

## Usage Examples

### cURL - Markdown Format

```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -H "Accept: text/markdown" \
     https://your-api.com/shows/123e4567-e89b-12d3-a456-426614174000/episodes/987fcdeb-51a2-4321-9876-543210987654/transcript
```

### cURL - JSON Format

```bash
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" \
     -H "Accept: application/json" \
     https://your-api.com/shows/123e4567-e89b-12d3-a456-426614174000/episodes/987fcdeb-51a2-4321-9876-543210987654/transcript
```

### JavaScript Fetch

```javascript
// Get transcript as markdown
const response = await fetch(
  "/shows/123e4567-e89b-12d3-a456-426614174000/episodes/987fcdeb-51a2-4321-9876-543210987654/transcript",
  {
    headers: {
      Authorization: "Bearer YOUR_JWT_TOKEN",
      Accept: "text/markdown",
    },
  }
);

const markdownContent = await response.text();
console.log(markdownContent);

// Get transcript as JSON
const jsonResponse = await fetch(
  "/shows/123e4567-e89b-12d3-a456-426614174000/episodes/987fcdeb-51a2-4321-9876-543210987654/transcript",
  {
    headers: {
      Authorization: "Bearer YOUR_JWT_TOKEN",
      Accept: "application/json",
    },
  }
);

const data = await jsonResponse.json();
console.log(data.transcript);
```

## Error Responses

| Status Code | Description                                     |
| ----------- | ----------------------------------------------- |
| 403         | Forbidden - Missing required permissions        |
| 404         | Episode not found or transcript not available   |
| 503         | Service unavailable - R2 storage not configured |
| 500         | Internal server error                           |

### Example Error Response

```json
{
  "type": "not_found",
  "title": "Not Found",
  "status": 404,
  "detail": "Transcript not available for this episode",
  "instance": "/shows/123/episodes/456/transcript"
}
```

## Prerequisites

For this endpoint to work:

1. **Episode must exist** and belong to the specified show
2. **Transcript must be available** - The episode's `transcriptUrl` field must be populated
3. **R2 storage** must be properly configured
4. **Transcript file** must exist in R2 storage

## Storage Structure

Transcripts are stored in R2 with the following key pattern:

```
transcripts/{episodeId}/{transcriptId}.txt
```

The episode's `transcriptUrl` field contains either:

- A full URL: `https://podcast-media.sesamy.dev/transcripts/episode-id/transcript-id.txt`
- An R2 URI: `r2://transcripts/episode-id/transcript-id.txt`

## Caching

- Markdown responses include `Cache-Control: public, max-age=3600` header (1 hour cache)
- JSON responses use default caching behavior

## Integration with Transcription Workflow

This endpoint works with transcripts generated by:

1. **Manual upload** - Transcripts uploaded directly to episodes
2. **Automatic transcription** - Generated via the transcription task/workflow system
3. **External transcription** - Transcripts uploaded from external services

The transcript content is served exactly as stored in R2, formatted appropriately for the requested content type.
